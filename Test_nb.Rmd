---
title: "Main Code Notebook"
author: "Pranav Natarajan"
date: "15/04/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
# loading required packages onto workbook instance
require(nbastatR)
require(tidyr)
require(dplyr)
# require(xlsx)
```

## Getting the dictionary of the players in BREF
```{r}
dictionary_bref_players<- dictionary_bref_players()
```

## Creating the column of first season
```{r}
dictionary_bref_players<- dictionary_bref_players %>% tidyr::separate(col=slugSeasonRookie, into = c('yearDraft', NA), remove=F)
```


## Getting draft data from 1985-2020, since 1985 is the year when the 3 pt. line and modern basketball came into being.
```{r}
draft_data<- drafts(draft_years = 1985:2021, nest_data = F) #draft from 1985-85 to 2021-22 szns
```



## Renaming namePlayer to namePlayerBREF in draft_data for ease in merging
```{r}
draft_data<- draft_data %>% dplyr::rename(namePlayerBREF = namePlayer)
```

## performing the join of draft_data and dictionary_bref_players['namePlayerBREF', 'yearDraft'] into the initial feature matrix X (not needed rn)
```{r}
X<- merge.data.frame(x = draft_data, 
                     y= dictionary_bref_players[, c("namePlayerBREF", "yearDraft", "slugPlayerBREF")],
                     by=c("namePlayerBREF", "yearDraft"), all=F)
```


## relocating the slugPlayerBREF column to be the first from the left for easier readability, and dropping Player_Profile_Flag (not needed rn)
```{r}
X<- X %>% relocate(slugPlayerBREF, .before = namePlayerBREF) %>% select(!(PLAYER_PROFILE_FLAG))
```


## Getting the player bios (salaries by szn)
```{r}
bref_bios(player_ids = X$slugPlayerBREF)
```


## Getting player stats of the players in X
```{r}
player_stats<- bref_players_stats(seasons = 1985:2021, 
                                  tables = c("totals", "advanced", "per_minute"),
                                  return_message = T)
```


## Joining the PerMinute, Advanced, and Total Data by slugPlayerSeason. Also creating new column anagulous to in Salaries table and merging Salary data by season.
```{r}
comprehensive_stats<- merge(x=dataBREFPlayerPerMinute, y=dataBREFPlayerAdvanced, by="slugPlayerSeason", all=F)
comprehensive_stats<- merge(x=comprehensive_stats, y=dataBREFPlayerTotals, by="slugPlayerSeason", all=F)
```

## Removing the columns which begin with `url` (not required at this point in the process)
```{r}
dataBREFPlayerPerMinute<- dataBREFPlayerPerMinute %>% select(!starts_with("url"))
```

## Sanity Check:- checking number of distinct values in the slugplayerseason column, as that is our primary key
```{r}
nums_pl<- comprehensive_stats %>% count(slugPlayerSeason) %>% arrange(desc(n)) %>% head()
nums_pl # these players have faulty NBA ID's and are therefore fail integrity check
```

## Noting that there are cases where there are more rows than needed, we remove those duplicate rows from the dataset.
```{r}
# code to remove duplicates from the comprehensive_stats dataframe
comprehensive_stats<- comprehensive_stats %>% distinct(slugPlayerSeason, .keep_all = T)# nrow = 16150
```

## Creating a slugPlayerSeason column for the Salaries data, and adding salary information for a player for a given season.
```{r}
# first, creating a separate column for the yearSeason
# then, using that and the slugPlayerBREF Column to create slugPlayerSeason

dataBREFPlayersSalaries<- dataBREFPlayersSalaries %>% separate(col=slugSeason, into=c("yearSeason", NA), sep='-', remove = F)

# add a 1 to yearseason column for uniformity and help in merging
dataBREFPlayersSalaries$yearSeason<- as.numeric(dataBREFPlayersSalaries$yearSeason) + 1


dataBREFPlayersSalaries<- dataBREFPlayersSalaries %>% unite(slugPlayerSeason, c("slugPlayerBREF", "yearSeason"), remove = F)
```


## Dropping the yearSeason column
```{r}
dataBREFPlayersSalaries<- dataBREFPlayersSalaries %>% select(!c("yearSeason"))
```

```{r}
# grouping salary data by slugPlayerSeason
dataBREFPlayersSalaries_grp<- dataBREFPlayersSalaries %>% select(c("slugPlayerSeason", "amountSalary")) %>% group_by(slugPlayerSeason) %>% summarise(totSalary = sum(amountSalary)) # this works!
```

## Joining Salary data vector to comprehensive_stats
```{r}
comprehensive_stats<- merge(x=comprehensive_stats, y=dataBREFPlayersSalaries_grp, by="slugPlayerSeason", all=F) # Success! 9684
```


## Dropping url columns
```{r}
comprehensive_stats<- comprehensive_stats %>% select(!starts_with("url"))# 10 columns dropped. 109 variables currently
```

## Dropping all instances of countTeamsPlayerSeasonTotals
```{r}
comprehensive_stats<- comprehensive_stats %>% select(!tidyselect::contains("countTeamsPlayerSeasonTotals"))# 1 column dropped
```

## Dropping extra info columns- Pt1
```{r}
comprehensive_stats<- comprehensive_stats %>% select(!(countTeamsPlayerSeasonPerMinute:`idPlayerNBA.y`)) # 95 variables currently
```

## Dropping extra info columns-Pt2
```{r}
comprehensive_stats<- comprehensive_stats %>% select(!(countTeamsPlayerSeason:idPlayerNBA))# 76 variables currently
```

## Dropping the columns of minutesPerMinute and minutesTotals
```{r}
comprehensive_stats<- comprehensive_stats %>% select(!c(minutesPerMinute, minutesTotals))# 2 columns dropped. 74 variables
```

## getting the counts of NAs in each column
```{r}
count_NAs<- apply(X=comprehensive_stats, MARGIN=2,
                  FUN= function(x) {return(sum(is.na(x)))})
count_NAs # 56 NAs in salary column, remove those rows
```

## drop 56 columns with NA salary values in them
```{r}
comprehensive_stats<- comprehensive_stats %>% drop_na(totSalary)
```


## Counting the number of duplicate primary keys (if any) in comprehensive_stats
```{r}
nums_pl<- comprehensive_stats %>% count(slugPlayerSeason) %>% arrange(desc(n))
View(nums_pl) # no duplicates!
```


## importing the csv of salary cap data
```{r}
salary_cap_data<- read.csv(file="sportsref_download.csv", header = T)
salary_cap_data<- salary_cap_data %>% dplyr::select(-salary_cap_in2021valuation)
```

## formatting the dataframe to remove the `$` sign and commas from columns and change datatype to numeric
```{r}
salary_cap_data$salary_cap<- stringr::str_replace_all(pattern="[$,]", replacement="", string =salary_cap_data$salary_cap)#%>% dplyr::mutate(salary_cap = as.numeric(salary_cap))
```

## creating the yearSeason column to ensure easy merging
```{r}
salary_cap_data<- salary_cap_data %>% tidyr::separate(col=yearSeason, into=c("yearSeason", NA), sep='-', remove=F)
```

## merging salary_cap_data to comprehensive_stats
```{r}
comprehensive_stats<- merge(x=comprehensive_stats, y=salary_cap_data, by.x= c("yearSeason.x"), by.y=c("yearSeason"))
```

## mutating a new column as the ratio between salary and salary_cap, called normalised_salary
```{r}
comprehensive_stats<- comprehensive_stats %>% dplyr::mutate(normalised_salary = totSalary / as.numeric(salary_cap)) # WORKS. do not change anything else.
```


## saving comprehensive stats in an RData file
```{r}
# saving as RDS
saveRDS(object=comprehensive_stats, file="comprehensive_stats.rds")
```